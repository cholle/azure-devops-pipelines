# Windows Image Build and Deployment Pipeline
# Demonstrates: Driver injection, image creation, and automated testing
# Uses approved PowerShell verb naming for operational clarity

trigger:
  branches:
    include:
    - main
  paths:
    include:
    - drivers/**
    - scripts/**
    - images/**

variables:
  imageBasePath: 'C:\Images'
  driverSourcePath: '$(Build.SourcesDirectory)\drivers'
  scriptPath: '$(Build.SourcesDirectory)\scripts'
  imageVersion: '22H2'

stages:
- stage: PrepareImage
  displayName: 'Prepare Windows Image'
  jobs:
  - job: ImageBuild
    displayName: 'Build and Configure Image'
    pool:
      vmImage: 'windows-latest'
    
    steps:
    - checkout: self
    
    # Test driver files (using approved verb: Test)
    - script: |
        echo Testing driver packages...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Test-Drivers.ps1" -DriverPath "$(driverSourcePath)"
      displayName: 'Test Drivers'
    
    # Mount base image
    - script: |
        echo Mounting base Windows image...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Mount-WindowsImage.ps1" -ImagePath "$(imageBasePath)\base-image.wim" -MountPoint "$(imageBasePath)\mount"
      displayName: 'Mount Base Image'
    
    # Add drivers to image (using approved verb: Add)
    - script: |
        echo Adding drivers to image...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Add-ImageDriver.ps1" -DriverPath "$(driverSourcePath)" -MountPoint "$(imageBasePath)\mount"
      displayName: 'Add Image Drivers'
    
    # Apply Windows updates (offline)
    - script: |
        echo Applying offline updates...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Publish-WindowsUpdate.ps1" -MountPoint "$(imageBasePath)\mount"
      displayName: 'Apply Updates'
    
    # Dismount and commit image
    - script: |
        echo Committing image changes...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Dismount-WindowsImage.ps1" -MountPoint "$(imageBasePath)\mount"
      displayName: 'Dismount Image'
    
    # Copy final image to artifact location
    - task: CopyFiles@2
      displayName: 'Stage Final Image'
      inputs:
        sourceFolder: '$(imageBasePath)'
        contents: 'final-image.wim'
        targetFolder: '$(Build.ArtifactStagingDirectory)'
    
    # Publish artifact
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Image Artifact'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'windows-image-$(imageVersion)-$(Build.BuildId)'

- stage: TestImage
  displayName: 'Test and Validate Image'
  dependsOn: PrepareImage
  condition: succeeded()
  jobs:
  - job: ImageValidation
    displayName: 'Validate Deployed Image'
    pool:
      vmImage: 'windows-latest'
    
    steps:
    # Download image artifact
    - task: DownloadBuildArtifacts@0
      displayName: 'Download Image'
      inputs:
        buildType: 'current'
        artifactName: 'windows-image-$(imageVersion)-$(Build.BuildId)'
        downloadPath: '$(System.ArtifactsDirectory)'
    
    # Mount and validate
    - script: |
        echo Mounting image for validation...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Mount-WindowsImage.ps1" -ImagePath "$(System.ArtifactsDirectory)\final-image.wim" -MountPoint "$(imageBasePath)\validate"
      displayName: 'Mount for Validation'
    
    # Check drivers are present (using approved verb: Test)
    - script: |
        echo Validating driver presence...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Test-ImageDrivers.ps1" -MountPoint "$(imageBasePath)\validate"
      displayName: 'Verify Drivers'
      continueOnError: false
    
    # Check system files integrity (using approved verb: Test)
    - script: |
        echo Checking system file integrity...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Test-SystemIntegrity.ps1" -MountPoint "$(imageBasePath)\validate"
      displayName: 'System Integrity Check'
    
    # Dismount
    - script: |
        echo Dismounting validation mount...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Dismount-WindowsImage.ps1" -MountPoint "$(imageBasePath)\validate"
      displayName: 'Dismount Validation'

- stage: DeployImage
  displayName: 'Deploy to Devices'
  dependsOn: TestImage
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: DeviceDeployment
    displayName: 'Deploy to Target Devices'
    pool:
      vmImage: 'windows-latest'
    
    steps:
    # Download validated image
    - task: DownloadBuildArtifacts@0
      displayName: 'Download Validated Image'
      inputs:
        buildType: 'current'
        artifactName: 'windows-image-$(imageVersion)-$(Build.BuildId)'
        downloadPath: '$(System.ArtifactsDirectory)'
    
    # Initialize devices (using approved verb: Initialize)
    - script: |
        echo Initializing target devices...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Initialize-Devices.ps1" -ImagePath "$(System.ArtifactsDirectory)\final-image.wim" -DeviceList "$(scriptPath)\devices.csv"
      displayName: 'Initialize Devices'
    
    # Deploy and validate on devices (using approved verb: Invoke)
    - script: |
        echo Deploying image and running device validation...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Invoke-DeploymentAndValidation.ps1" -ImagePath "$(System.ArtifactsDirectory)\final-image.wim"
      displayName: 'Deploy and Validate'
    
    # Collect device logs (using approved verb: Get)
    - script: |
        echo Collecting device validation logs...
        powershell -ExecutionPolicy Bypass -File "$(scriptPath)\Get-DeviceLogs.ps1" -OutputPath "$(Build.ArtifactStagingDirectory)\logs"
      displayName: 'Get Device Logs'
      continueOnError: true
    
    # Publish test results
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Validation Results'
      condition: always()
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)\logs'
        artifactName: 'device-validation-logs-$(Build.BuildId)'
